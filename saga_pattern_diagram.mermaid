flowchart TD
    Start([Cliente: POST /api/reservar]) --> Orq[Orquestador: Servicio de Reservas y Pagos]
    
    Orq --> Step1[Paso 1: Validar Datos de Solicitud]
    Step1 -->|Datos VÃ¡lidos| Step2[Paso 2: Verificar Usuario Existe]
    Step1 -->|Datos InvÃ¡lidos| FailValidation[âŒ Error: Datos invÃ¡lidos]
    FailValidation --> EndFail1([Respuesta 400: Bad Request])
    
    Step2 -->|Usuario Existe| Step3[Paso 3: Verificar Disponibilidad de Entradas]
    Step2 -->|Usuario No Existe| FailUser[âŒ Error: Usuario no encontrado]
    FailUser --> EndFail2([Respuesta 404: Usuario no encontrado])
    
    Step3 -->|Entradas Disponibles| Step4[Paso 4: Reservar Entradas en Redis<br/>DECR entradas_disponibles]
    Step3 -->|Sin Disponibilidad| FailInventory[âŒ Error: Sin entradas disponibles]
    FailInventory --> EndFail3([Respuesta 409: Sold Out])
    
    Step4 -->|Reserva Exitosa| Step5[Paso 5: Procesar Pago]
    Step5 -->|Pago Exitoso| Step6[Paso 6: Confirmar Reserva<br/>Guardar en MongoDB]
    Step5 -->|Pago Fallido| Comp1[ðŸ”„ CompensaciÃ³n 1:<br/>Liberar Entradas en Redis<br/>INCR entradas_disponibles]
    
    Comp1 --> FailPayment[âŒ Error: Pago rechazado]
    FailPayment --> EndFail4([Respuesta 402: Payment Required])
    
    Step6 -->|ConfirmaciÃ³n Exitosa| Step7[Paso 7: Actualizar Historial Usuario<br/>Push reserva_id a historial_compras]
    Step6 -->|Fallo en ConfirmaciÃ³n| Comp2[ðŸ”„ CompensaciÃ³n 2:<br/>1. Reembolsar Pago<br/>2. Liberar Entradas]
    
    Comp2 --> FailConfirm[âŒ Error: Fallo al confirmar]
    FailConfirm --> EndFail5([Respuesta 500: Internal Server Error])
    
    Step7 -->|ActualizaciÃ³n Exitosa| Step8[Paso 8: Actualizar Evento<br/>Push reserva_id a reservas_activas]
    Step7 -->|Fallo ActualizaciÃ³n| Comp3[ðŸ”„ CompensaciÃ³n 3:<br/>1. Reembolsar Pago<br/>2. Liberar Entradas<br/>3. Eliminar Reserva]
    
    Comp3 --> FailUpdate[âŒ Error: Fallo al actualizar historial]
    FailUpdate --> EndFail6([Respuesta 500: Internal Server Error])
    
    Step8 -->|Ã‰xito| Success[âœ… TransacciÃ³n SAGA Completada]
    Step8 -->|Fallo| Comp4[ðŸ”„ CompensaciÃ³n 4:<br/>1. Reembolsar Pago<br/>2. Liberar Entradas<br/>3. Revertir Historial Usuario<br/>4. Eliminar Reserva]
    
    Comp4 --> FailEvent[âŒ Error: Fallo al actualizar evento]
    FailEvent --> EndFail7([Respuesta 500: Internal Server Error])
    
    Success --> EndSuccess([Respuesta 201: Reserva Creada<br/>Retorna: reserva_id, detalles])
    
    style Orq fill:#4A90E2,stroke:#2E5C8A,color:#fff
    style Success fill:#4CAF50,stroke:#2E7D32,color:#fff
    style FailValidation fill:#F44336,stroke:#C62828,color:#fff
    style FailUser fill:#F44336,stroke:#C62828,color:#fff
    style FailInventory fill:#F44336,stroke:#C62828,color:#fff
    style FailPayment fill:#F44336,stroke:#C62828,color:#fff
    style FailConfirm fill:#F44336,stroke:#C62828,color:#fff
    style FailUpdate fill:#F44336,stroke:#C62828,color:#fff
    style FailEvent fill:#F44336,stroke:#C62828,color:#fff
    style Comp1 fill:#FF9800,stroke:#E65100,color:#fff
    style Comp2 fill:#FF9800,stroke:#E65100,color:#fff
    style Comp3 fill:#FF9800,stroke:#E65100,color:#fff
    style Comp4 fill:#FF9800,stroke:#E65100,color:#fff
    style Step4 fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style Step5 fill:#9C27B0,stroke:#6A1B9A,color:#fff
    style Step6 fill:#9C27B0,stroke:#6A1B9A,color:#fff